<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/cadastro.css"> 
    <title>VidaPlus - Cadastro</title>

</head>
<body>
    
    <header class="header">
        <div class="logo">VidaPlus</div>
        <nav class="nav-menu">
            <ul class="nav-links">
                <li><a href="#servicos">Serviços</a></li>
                <li><a href="#sobre">Sobre</a></li>
            </ul>
            <div class="nav-buttons">
                <a href="#marcar-consulta" class="btn-primary">Marcar Consulta</a>
                <a href="#cadastro" class="btn-secondary">Cadastro/Login</a>
            </div>
        </nav>
    </header>

    
    <main class="main-container">
        <form class="login-form" id="registrationForm">
            <h1 class="form-title">Crie Sua Conta</h1>
            <div class="form-group" id="cpfGroup">
                <label for="cpf" class="form-label">CPF</label>
                <input 
                    type="text" 
                    id="cpf" 
                    name="cpf" 
                    class="form-input" 
                    placeholder="Insira seu CPF"
                    maxlength="14"
                    required
                >
                <div class="error-message" id="cpfError">CPF inválido</div>
            </div>

            <div class="form-group" id="dateOfBirthGroup">
                <label for="dateOfBirth" class="form-label">Data de Nascimento</label>
                <input 
                    type="date" 
                    id="dateOfBirth" 
                    name="dateOfBirth" 
                    class="form-input"
                    required
                >
                <div class="error-message" id="dateOfBirthError">Data de nascimento inválida</div>
            </div>

            <div class="form-group" id="emailGroup">
                <label for="email" class="form-label">Email</label>
                <input 
                    type="email" 
                    id="email" 
                    name="email" 
                    class="form-input" 
                    placeholder="exemplo@dominio.com"
                    required
                >
                <div class="error-message" id="emailError">Email inválido</div>
            </div>

            <div class="form-group" id="passwordGroup">
                <label for="password" class="form-label">Senha</label>
                <input 
                    type="password" 
                    id="password" 
                    name="password" 
                    class="form-input" 
                    placeholder="Insira sua senha"
                    required
                >
                <div class="error-message" id="passwordError">Senha é obrigatória</div>
            </div>

            <div class="forgot-password">
                <p><a href="#login.html">Já tem login?</a></p>
            </div>

            <button type="submit" class="btn-login" id="registerBtn">Cadastrar</button>
        </form>
    </main>

    <script>

        function formatCPF(value) {
            return value
                .replace(/\D/g, '')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d{1,2})/, '$1-$2')
                .replace(/(-\d{2})\d+?$/, '$1');
        }

        function validateCPF(cpf) {
            cpf = cpf.replace(/[^\d]+/g, '');
            if (cpf.length !== 11 || !!cpf.match(/(\d)\1{10}/)) {
                return false;
            }
            const digits = cpf.split('').map(el => +el);
            const rest = (count) => {
                return (digits.slice(0, count - 12)
                    .reduce((soma, el, index) => (soma + el * (count - index)), 0) * 10) % 11 % 10;
            };
            return rest(10) === digits[9] && rest(11) === digits[10];
        }

        function validateEmail(email) {
            const re = /^\S+@\S+\.\S+$/;
            return re.test(String(email).toLowerCase());
        }

        function validateDateOfBirth(dateString) {
            const birthDate = new Date(dateString);
            const today = new Date();
            
            birthDate.setMinutes(birthDate.getMinutes() + birthDate.getTimezoneOffset());
            today.setHours(0, 0, 0, 0);

            if (!dateString || isNaN(birthDate.getTime())) {
                return { isValid: false, message: "Data de nascimento é obrigatória." };
            }

            if (birthDate > today) {
                return { isValid: false, message: "A data de nascimento não pode ser no futuro." };
            }

            const age_dt = new Date(today.valueOf() - birthDate.valueOf());
            const age = Math.abs(age_dt.getUTCFullYear() - 1970);

            if (age < 18) {
                return { isValid: false, message: "Você deve ter pelo menos 18 anos." };
            }

            return { isValid: true, message: "" };
        }
        
        const registrationForm = document.getElementById('registrationForm');
        const registerBtn = document.getElementById('registerBtn');

        const cpfInput = document.getElementById('cpf');
        const dateOfBirthInput = document.getElementById('dateOfBirth');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');

        cpfInput.addEventListener('input', function(e) {
            e.target.value = formatCPF(e.target.value);
            document.getElementById('cpfGroup').classList.remove('error');
        });

        dateOfBirthInput.addEventListener('input', function() {
            document.getElementById('dateOfBirthGroup').classList.remove('error');
        });
        
        emailInput.addEventListener('input', function() {
            document.getElementById('emailGroup').classList.remove('error');
        });

        passwordInput.addEventListener('input', function() {
            document.getElementById('passwordGroup').classList.remove('error');
        });

        function validateForm() {
            let isValid = true;
            
            const cpfGroup = document.getElementById('cpfGroup');
            if (!cpfInput.value || !validateCPF(cpfInput.value)) {
                cpfGroup.classList.add('error');
                isValid = false;
            } else {
                cpfGroup.classList.remove('error');
            }

            const dateOfBirthGroup = document.getElementById('dateOfBirthGroup');
            const dateValidation = validateDateOfBirth(dateOfBirthInput.value);
            if (!dateValidation.isValid) {
                dateOfBirthGroup.classList.add('error');
                document.getElementById('dateOfBirthError').textContent = dateValidation.message;
                isValid = false;
            } else {
                dateOfBirthGroup.classList.remove('error');
            }

            const emailGroup = document.getElementById('emailGroup');
            if (!emailInput.value || !validateEmail(emailInput.value)) {
                emailGroup.classList.add('error');
                isValid = false;
            } else {
                emailGroup.classList.remove('error');
            }
    
            const passwordGroup = document.getElementById('passwordGroup');
            if (!passwordInput.value || passwordInput.value.length < 1) {
                passwordGroup.classList.add('error');
                isValid = false;
            } else {
                passwordGroup.classList.remove('error');
            }
            
            return isValid;
        }


        registrationForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                return;
            }
            
            registerBtn.classList.add('loading');
            registerBtn.disabled = true;
            
            const formData = {
                cpf: cpfInput.value.replace(/[^\d]+/g, ''),
                dateOfBirth: dateOfBirthInput.value,
                email: emailInput.value,
                password: passwordInput.value
            };
            
            console.log("Dados a serem enviados:", formData);

            try {
                const response = await fetch('/api/auth/register', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.token) {
                        localStorage.setItem('authToken', data.token);
                    }
                    alert('Cadastro realizado com sucesso!');
                    window.location.href = '/dashboard';
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || 'Erro ao realizar cadastro. Verifique os dados.');
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('Erro de conexão. Tente novamente mais tarde.');
            } finally {
                registerBtn.classList.remove('loading');
                registerBtn.disabled = false;
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const navLinks = document.querySelectorAll('a[href^="#"]');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log(`Navegação simulada para: ${this.getAttribute('href')}`);
                });
            });
        });
    </script>
</body>
</html>